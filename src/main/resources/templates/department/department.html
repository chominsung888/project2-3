<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/department/department.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>
<h1>부서관리</h1>
<div class="button-container">
  <button class="btn btn-success" onclick="showForm()">부서등록</button>
</div>
<table id="departmentTable">
  <thead>
  <tr>
    <th>부서번호</th>
    <th>부서이름</th>
    <th>부서 위치</th>
    <th>소속 인원 수</th>
  </tr>
  </thead>
  <tbody id="departmentTableBody">
  <!-- 부서 정보 표시 -->
  </tbody>
</table>
<!-- 부서 등록 폼-->
<div id="departmentForm" style="display:none;">
  <h2>부서등록</h2>
  <form id="addDepartmentForm" action="/department/add" method="post">
    <label for="deptName">부서이름:</label>
    <input type="text" id="deptName" name="dptName"><br>
    <label for="deptLocation">부서 위치:</label>
    <input type="text" id="deptLocation" name="location"><br>
    <button type="submit" class="btn btn-success">등록</button>
  </form>
</div>
  <!-- 멤버 리스트 표시 컨테이너 -->
  <div id="memberListContainer"></div>

<script>
  // 부서 등록 폼 표시 함수
  function showForm() {
    document.getElementById("departmentForm").style.display = 'block';
  }

  //부서 인원 조회 함수
  function showDepartmentMembers(){
    window.location.href="/department/members"; //변경 필요
  }

  // 페이지 로드시 초기 부서 목록을 불러옵니다.
  $(document).ready(function() {
    loadDepartments();

    // 폼 제출 시
    $("#addDepartmentForm").submit(function(event) {
      // 폼의 기본 동작을 중지
      event.preventDefault();
      // 서버로 폼 데이터를 전송
      $.ajax({
        type: "POST",
        url: $(this).attr("action"),
        data: $(this).serialize(), // 폼 데이터를 시리얼라이즈하여 전송
        success: function(response) {
          // 성공적으로 등록된 경우, 부서 목록 다시 로드
          loadDepartments();
          // 등록 폼 숨김
          $("#departmentForm").hide();
          // 입력 필드 초기화
          $("#deptName").val("");
          $("#deptLocation").val("");
        },
        error: function(xhr, status, error) {
          // 에러 발생 시 처리
          console.error(error);
          alert("부서 등록에 실패했습니다.");
        }
      });
    });
  });

  // 부서 목록을 불러오는 함수
function loadDepartments() {
  $.get("/department/list", function(data) {
    console.log(data); // 데이터 확인
    var tbody = $("#departmentTableBody");
    tbody.empty();
    // 데이터가 배열 형태인지 확인
    if (Array.isArray(data)) {
      // 배열 형태인 경우
      data.forEach(function(department) {
        var row = "<tr>" +
          "<td><a href='/department/members?deptId=" + department.id + "'>" + department.id + "</a></td>" +
          "<td><a href='/department/members?deptId=" + department.id + "'>" + department.dptName + "</a></td>" +
          "<td><a href='/department/members?deptId=" + department.id + "'>" + department.location + "</a></td>" +
          "<td><a href='/department/members?deptId=" + department.id + "'>" + department.memberCount + "</a></td>" +
          "</tr>";
        tbody.append(row);
      });
    } else {
      // 배열의 형태가 아닌 경우
      var row = "<tr>" +
        "<td><a href='/department/members?deptId=" + data.id + "'>" + data.id + "</a></td>" +
        "<td><a href='/department/members?deptId=" + data.id + "'>" + data.dptName + "</a></td>" +
        "<td><a href='/department/members?deptId=" + data.id + "'>" + data.location + "</a></td>" +
        "<td><a href='/department/members?deptId=" + data.id + "'>" + data.memberCount + "</a></td>" +
        "</tr>";
      tbody.append(row);
    }
  });
}
// 부서 소속 멤버를 표시하는 함수
  function showMembers(members){
    var memberList="<ul>";
    members.forEach(function(member){
    memberList +="<li>" + member.name +"(" +member.role+")</li>";
  });
  memberList +="</ul>";
  $("#memberListContainer").html(memberList); //멤버 리스트를 표시할 컨테이너에 추가
  }

  $(document).ready(function(){
    loadDepartments();
  });


</script>

</body>
</html>
