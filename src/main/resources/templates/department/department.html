<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/department/department.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .department, .sub-department {
      margin-left: 20px;
    }
    .add-sub-department-form {
      display: none;
    }
  </style>
</head>
<body>
<h1>부서관리</h1>
<div class="button-container">
  <button class="btn btn-success" onclick="showForm()">부서등록</button>
</div>
<div id="departmentTree">
  <!-- 부서 조직도 표시 -->
</div>

<!-- 부서 등록 폼 -->
<div id="departmentForm" style="display:none;">
  <h2>부서등록</h2>
  <form id="addDepartmentForm" action="/department/add" method="post">
    <label for="deptName">부서이름:</label>
    <input type="text" id="deptName" name="dptName"><br>
    <label for="deptLocation">부서 위치:</label>
    <input type="text" id="deptLocation" name="location"><br>
    <label for="parentDept">상위 부서:</label>
    <select id="parentDept" name="parentDeptId">
      <option value="">없음</option>
      <!-- 상위 부서 선택 옵션 -->
    </select><br>
    <button type="submit" class="btn btn-success">등록</button>
  </form>
</div>
<!-- 멤버 리스트 표시 컨테이너 -->
<div id="memberListContainer"></div>

<script>
  // 부서 등록 폼 표시 함수
  function showForm() {
    document.getElementById("departmentForm").style.display = 'block';
  }

  // 페이지 로드시 초기 부서 목록을 불러옵니다.
  $(document).ready(function() {
    loadDepartments();
    loadParentDepartments();

  //부서 클릭 이벤트 핸들러
 $(document).on('click','.department',function(){
    var departmentId = $(this).data('department-id');
    var departmentName = $(this).text(); // 부서 이름 가져오기
    // 해당 부서의 ID를 사용하여 새 URL 생성
    console.log("Department ID: " + departmentId);
    console.log("Department Name: " + departmentName);

    if(departmentId !== undefined && departmentName !== undefined){
        var newUrl = "/department/members?deptId=" + departmentId + "&dptName=" + encodeURIComponent(departmentName);
        window.location.href = newUrl;
    } else {
        console.error("Invalid departmentId or departmentName");
    }
});

    // 폼 제출 시
    $("#addDepartmentForm").submit(function(event) {
      // 폼의 기본 동작을 중지
      event.preventDefault();
      // 서버로 폼 데이터를 전송
      $.ajax({
        type: "POST",
        url: $(this).attr("action"),
        data: $(this).serialize(), // 폼 데이터를 시리얼라이즈하여 전송
        success: function(response) {
          // 성공적으로 등록된 경우, 부서 목록 다시 로드
          loadDepartments();
          // 등록 폼 숨김
          $("#departmentForm").hide();
          // 입력 필드 초기화
          $("#deptName").val("");
          $("#deptLocation").val("");
          // 상위 부서 목록 다시 로드
          loadParentDepartments();
        },
        error: function(xhr, status, error) {
          // 에러 발생 시 처리
          console.error(error);
          alert("부서 등록에 실패했습니다.");
        }
      });
    });
  });

  // 부서 목록을 불러오는 함수
  function loadDepartments() {
    $.get("/department/list", function(data) {
      console.log(data); // 데이터 확인
      var departmentTree = $("#departmentTree");
      departmentTree.empty();
      // 부서 정보를 표시하는 함수 호출
      displayDepartments(data, departmentTree);
    });
  }

  // 상위 부서 목록을 불러오는 함수
  function loadParentDepartments() {
    $.get("/department/parents", function(data) {
      console.log(data); // 데이터 확인
      var parentDeptSelect = $("#parentDept");
      parentDeptSelect.empty();
      parentDeptSelect.append("<option value=''>없음</option>"); // 없음 옵션 추가
      // 상위 부서 옵션 추가
      data.forEach(function(parent) {
        parentDeptSelect.append("<option value='" + parent.id + "'>" + parent.dptName + "</option>");
      });
    });
  }

  // 부서 정보를 표시하는 함수
  function displayDepartments(departments, parentElement) {
    departments.forEach(function(department) {
      var departmentElement= $("<div>").addClass("department");
       //부서 이름과 함께 링크 추가
        var departmentLink = $("<a>").attr("href", "/department/members?deptId=" + department.id).text(department.dptName);
        departmentElement.append(departmentLink);
        departmentElement.append("<button onclick='showSubDepartmentForm("+department.id+")'>+</button>");

      parentElement.append(departmentElement);

      var subDepartmentForm = $("<div>").addClass("add-sub-department-form").attr("id", "sub-department-form-" + department.id);
      subDepartmentForm.html(`
        <form onsubmit="addSubDepartment(event, ${department.id})">
          <label for="subDeptName-${department.id}">하위 부서 이름:</label>
          <input type="text" id="subDeptName-${department.id}" name="dptName" required>
          <label for="subDeptLocation-${department.id}">위치:</label>
          <input type="text" id="subDeptLocation-${department.id}" name="location" required>
          <button type="submit">추가</button>
        </form>
      `);
      departmentElement.append(subDepartmentForm);

      if (department.childDepartments && department.childDepartments.length > 0) {
        var childElement = $("<div>").addClass("sub-department");
        departmentElement.append(childElement);
        displayDepartments(department.childDepartments, childElement);
      }
    });
  }


  function showSubDepartmentForm(departmentId) {
    $("#sub-department-form-" + departmentId).toggle();
  }


  function addSubDepartment(event, parentDeptId) {
    event.preventDefault();
    var form = $(event.target);
    var data = form.serialize() + "&parentDeptId=" + parentDeptId;

    $.ajax({
      type: "POST",
      url: "/department/add",
      data: data,
      success: function(response) {
        loadDepartments();
      },
      error: function(xhr, status, error) {
        console.error(error);
        alert("하위 부서 등록에 실패했습니다.");
      }
    });
  }
</script>
</body>
</html>
